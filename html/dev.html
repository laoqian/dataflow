<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title></title>
    <script src="../js/mui.min.js"></script>
    <script src="../js/jquery.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <style>
        .mui-bar-footer .mui-row {
            height: 100%;
        }

        #dev-list .mui-col-xs-4, .mui-bar-footer .mui-col-xs-4 {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #dev-list .mui-row{
            height: 36px;
        }

    </style>
    <script type="text/javascript" charset="utf-8">

    </script>
</head>
<body>
<header class="mui-bar mui-bar-nav">
    <h1 class="mui-title">设备列表</h1>
</header>

<div id="dev-list" class="mui-content mui-scroll-wrapper">
    <div class="mui-row">
        <button onclick="searchDev">开始搜索</button>
        <button>断开连接</button>
        <button>关闭蓝牙</button>
    </div>
    <ul class="mui-table-view">
    </ul>
</div>

<footer class="mui-bar mui-bar-footer">
    <div class="mui-row">
        <div class="mui-col-xs-4">监听</div>
        <div class="mui-col-xs-4">分析</div>
        <div class="mui-col-xs-4">我的</div>
    </div>
</footer>
</body>
<script type="text/javascript">

    let main,BluetoothAdapter,BAdapter,BluetoothDevice;

    function searchDev() {
        if (!BAdapter.isEnabled()) {
            BAdapter.enable();
        }

        let foundreceiver = plus.android.implements('io.dcloud.android.content.BroadcastReceiver', {
            onReceive: function(context, intent) {
                plus.android.importClass(intent);
                console.log(intent.getAction());
                let BleDevice  = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
                console.log("蓝牙设备：" + BleDevice.getName() + BleDevice.getAddress());
                main.unregisterReceiver(foundreceiver);
            }
        });

        let IntentFilterScan = plus.android.importClass('android.content.IntentFilter');
        let filterScan = new IntentFilterScan();
        filterScan.addAction(BluetoothDevice.ACTION_FOUND); //搜索设备
        main.registerReceiver(foundreceiver, filterScan); //注册监听
    }

    function connectDev (device) {
        let UUID = plus.android.importClass('java.util.UUID');
        let uuid = UUID.fromString("38400000-8cf0-11bd-b23e-10b96e4ef00d");
        let bluetoothSocket = device.createInsecureRfcommSocketToServiceRecord(uuid);
        plus.android.importClass(bluetoothSocket);
        if (!bluetoothSocket.isConnected()) {
            mask.show();//显示遮罩
            let w = plus.nativeUI.showWaiting("连接-" + device.getName());
            setTimeout(function () {
                    try {
                        let ret = bluetoothSocket.connect();
                    } catch
                        (e) {
                        mui.alert("无法连接到:" + device.getName(), "提示");
                    }

                    w.close();
                    mask.close();
                    if (bluetoothSocket.isConnected()) {
                        isOpen = true;
                    }
                },
                1000
            )
            ;
        }
    }

    function bluetooth_list() {
        let lists = BAdapter.getBondedDevices();
        plus.android.importClass(lists);

        let iterator = lists.iterator();
        plus.android.importClass(iterator);
        let devList = [];
        let contanier = $('.mui-table-view');
        contanier.html('');
        while (iterator.hasNext()) {
            let d = iterator.next();
            plus.android.importClass(d);
            let e = document.createElement('li');
            $(e).attr('_key', devList.length)
                .text(d.getName())
                .addClass("mui-table-view-cell");
            $(e).click(function () {
                let key = $(this).attr('_key');
                connectDev(devList[key]);
            });

            devList.push(d);
            contanier.append(e);
        }
    }


    // H5 plus事件处理
    function plusReady() {
        mui.init();
        let mask = mui.createMask();//callback为用户点击蒙版时自动执行的回调；

        main = plus.android.runtimeMainActivity();
        BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
        BAdapter = BluetoothAdapter.getDefaultAdapter();
        BluetoothDevice = plus.android.importClass('android.bluetooth.BluetoothDevice');

    }

    //监听“plusready”事件
    document.addEventListener("plusready", plusReady, false);
</script>
</html>